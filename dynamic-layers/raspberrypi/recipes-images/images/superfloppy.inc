SUPERFLOPPY_BLOCK_SIZE = "512"
SUPERFLOPPY_BPB_OFFSET = "11"
SUPERFLOPPY_BPB_SIZE = "76"
SUPERFLOPPY_VFAT_BPB_RESERVED_LOG_SEC = "4"
SUPERFLOPPY_BPB_RESERVED_LOG_SEC_LB_OFFSET = "14"
SUPERFLOPPY_BPB_RESERVED_LOG_SEC_HB_OFFSET = "15"

SUPERFLOPPY_BOOT_PART_LOCATION_BYTE = "$(( ${BOOT_ALIGN_KB} * 1024 ))"
SUPERFLOPPY_BOOT_PART_BPB_LOCATION = "$(( ${SUPERFLOPPY_BOOT_PART_LOCATION_BYTE} + ${SUPERFLOPPY_BPB_OFFSET} ))"
python () {
    align_b = int(d.getVar("BOOT_ALIGN_KB"))*1024
    bs = int(d.getVar("SUPERFLOPPY_BLOCK_SIZE"))
    if align_b/bs > 65535:
        bb.fatal("Superfloppy format not possible if first partition is located at offset greater than 32767 KB (sector 65535=0xFFFF). Aborting.")
}
SUPERFLOPPY_BOOT_PART_BPB_RESERVED_LOG_SEC_HB = "$(( ${SUPERFLOPPY_BOOT_PART_LOCATION_BYTE}/${SUPERFLOPPY_BLOCK_SIZE} >> 8 ))"
SUPERFLOPPY_BOOT_PART_BPB_RESERVED_LOG_SEC_LB = "$(( ${SUPERFLOPPY_BOOT_PART_LOCATION_BYTE}/${SUPERFLOPPY_BLOCK_SIZE} & 255 + ${SUPERFLOPPY_VFAT_BPB_RESERVED_LOG_SEC} ))"

COMPRESSIONTYPES += "superfloppy"
CONVERSION_CMD:superfloppy = "sh -c 'cp ${IMAGE_NAME}${IMAGE_NAME_SUFFIX}.${type} ${IMAGE_NAME}${IMAGE_NAME_SUFFIX}.${type}.superfloppy; \
			      dd bs=1 if=${IMAGE_NAME}${IMAGE_NAME_SUFFIX}.${type} of=${IMAGE_NAME}${IMAGE_NAME_SUFFIX}.${type}.superfloppy skip=${SUPERFLOPPY_BOOT_PART_BPB_LOCATION} seek=${SUPERFLOPPY_BPB_OFFSET} count=${SUPERFLOPPY_BPB_SIZE} conv=notrunc; \
			      printf "%x" $(echo ${SUPERFLOPPY_BOOT_PART_BPB_RESERVED_LOG_SEC_LB}) | xxd -r -p | dd of=${IMAGE_NAME}${IMAGE_NAME_SUFFIX}.${type}.superfloppy bs=1 seek=${SUPERFLOPPY_BPB_RESERVED_LOG_SEC_LB_OFFSET} count=1 conv=notrunc; \
			      printf "%x" $(echo ${SUPERFLOPPY_BOOT_PART_BPB_RESERVED_LOG_SEC_HB}) | xxd -r -p | dd of=${IMAGE_NAME}${IMAGE_NAME_SUFFIX}.${type}.superfloppy bs=1 seek=${SUPERFLOPPY_BPB_RESERVED_LOG_SEC_HB_OFFSET} count=1 conv=notrunc' \
"
CONVERSION_DEPENDS:superfloppy = "xxd-native"
